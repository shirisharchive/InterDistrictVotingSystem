<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Voting System</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>"
    />
    <link rel="stylesheet" href="../css/style.css" />
    <style>
      .admin-dashboard {
        min-height: 100vh;
        background: #f5f7fa;
      }

      .admin-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .admin-header h1 {
        margin: 0;
        font-size: 1.5em;
      }

      .admin-user-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .logout-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s;
      }

      .logout-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .dashboard-content {
        max-width: 1200px;
        margin: 30px auto;
        padding: 0 20px;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .stat-card .stat-value {
        font-size: 2.5em;
        color: #667eea;
        font-weight: bold;
        margin: 10px 0;
      }

      .stat-card .stat-label {
        color: #666;
        font-size: 14px;
        text-transform: uppercase;
      }

      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #e9ecef;
      }

      .tab-btn {
        background: transparent;
        border: none;
        padding: 15px 25px;
        cursor: pointer;
        font-size: 16px;
        color: #666;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
      }

      .tab-btn.active {
        color: #667eea;
        border-bottom-color: #667eea;
      }

      .tab-content {
        display: none;
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .tab-content.active {
        display: block;
      }

      .results-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      .results-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #e9ecef;
      }

      .results-table td {
        padding: 12px;
        border-bottom: 1px solid #e9ecef;
      }

      .results-table tbody tr:hover {
        background: #f8f9fa;
      }

      .rank-badge {
        display: inline-block;
        background: #667eea;
        color: white;
        padding: 4px 8px;
        border-radius: 50%;
        width: 30px;
        text-align: center;
        font-weight: bold;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 8px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        transition: width 0.3s;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .loading::after {
        content: "";
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .alert {
        padding: 15px 20px;
        margin-bottom: 20px;
        border-radius: 5px;
        display: none;
      }

      .alert.show {
        display: block;
      }

      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .district-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        border-left: 4px solid #667eea;
      }
    </style>
  </head>
  <body>
    <div class="admin-dashboard">
      <div class="admin-header">
        <h1>üìä Admin Dashboard</h1>
        <div class="admin-user-info">
          <span id="adminName"></span>
          <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
      </div>

      <div class="dashboard-content">
        <div id="alert" class="alert"></div>

        <div class="district-info">
          <strong>üìç District:</strong> <span id="districtName"></span>
          <strong style="margin-left: 20px">üìå Area:</strong>
          <span id="areaName"></span>
        </div>

        <div class="dashboard-grid" id="statsGrid">
          <div class="loading">Loading statistics...</div>
        </div>

        <div class="tabs">
          <button class="tab-btn active" onclick="switchTab('candidates')">
            üó≥Ô∏è Candidate Results
          </button>
          <button class="tab-btn" onclick="switchTab('parties')">
            üéØ Party Results
          </button>
        </div>

        <div id="candidates" class="tab-content active">
          <table class="results-table" id="candidatesTable">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Candidate Name</th>
                <th>Party</th>
                <th>Votes</th>
                <th>Percentage</th>
              </tr>
            </thead>
            <tbody id="candidatesBody">
              <tr>
                <td colspan="5" style="text-align: center">
                  <div class="loading">Loading candidate results...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div id="parties" class="tab-content">
          <table class="results-table" id="partiesTable">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Party Name</th>
                <th>Votes</th>
                <th>Percentage</th>
              </tr>
            </thead>
            <tbody id="partiesBody">
              <tr>
                <td colspan="4" style="text-align: center">
                  <div class="loading">Loading party results...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      const API_BASE_URL = "http://localhost:5500/api";
      let adminToken = null;
      let adminInfo = null;

      // Check admin authentication on page load
      window.addEventListener("load", () => {
        adminToken = localStorage.getItem("adminToken");
        adminInfo = JSON.parse(localStorage.getItem("adminInfo")) || {};

        if (!adminToken) {
          window.location.href = "admin-login.html";
          return;
        }

        // Display admin info
        document.getElementById("adminName").textContent =
          `üëã ${adminInfo.name || "Admin"}`;
        document.getElementById("districtName").textContent =
          adminInfo.district || "All Districts";
        document.getElementById("areaName").textContent =
          adminInfo.area || "All Areas";

        // Load dashboard data
        loadDashboard();
        loadCandidateResults();
        loadPartyResults();
      });

      async function loadDashboard() {
        try {
          const response = await fetch(`${API_BASE_URL}/admin/dashboard`, {
            headers: {
              Authorization: `Bearer ${adminToken}`,
            },
          });

          const result = await response.json();

          if (result.success) {
            const stats = [
              {
                label: "Total Voters",
                value: result.data.totalVoters,
                icon: "üë•",
              },
              {
                label: "Votes Cast",
                value: result.data.votesCast,
                icon: "üó≥Ô∏è",
              },
              {
                label: "Voter Turnout",
                value: result.data.turnout,
                icon: "üìä",
              },
            ];

            const statsGrid = document.getElementById("statsGrid");
            statsGrid.innerHTML = stats
              .map(
                (stat) => `
              <div class="stat-card">
                <div style="font-size: 2em;">${stat.icon}</div>
                <div class="stat-label">${stat.label}</div>
                <div class="stat-value">${stat.value}</div>
              </div>
            `
              )
              .join("");
          } else {
            showAlert(result.message || "Error loading dashboard", "error");
          }
        } catch (error) {
          console.error("Dashboard error:", error);
          showAlert("Error loading dashboard data", "error");
        }
      }

      async function loadCandidateResults() {
        try {
          const response = await fetch(
            `${API_BASE_URL}/admin/results/candidates`,
            {
              headers: {
                Authorization: `Bearer ${adminToken}`,
              },
            }
          );

          const result = await response.json();

          if (result.success) {
            const tbody = document.getElementById("candidatesBody");
            tbody.innerHTML = result.data
              .map(
                (item, index) => `
              <tr>
                <td><span class="rank-badge">${index + 1}</span></td>
                <td><strong>${item.candidate_name}</strong></td>
                <td>${item.party_name || "Independent"}</td>
                <td><strong>${item.vote_count || 0}</strong></td>
                <td>
                  <div>${item.vote_percentage || 0}%</div>
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: ${item.vote_percentage || 0}%"></div>
                  </div>
                </td>
              </tr>
            `
              )
              .join("");
          } else {
            document.getElementById("candidatesBody").innerHTML =
              '<tr><td colspan="5">No candidate data available</td></tr>';
          }
        } catch (error) {
          console.error("Candidate results error:", error);
        }
      }

      async function loadPartyResults() {
        try {
          const response = await fetch(
            `${API_BASE_URL}/admin/results/parties`,
            {
              headers: {
                Authorization: `Bearer ${adminToken}`,
              },
            }
          );

          const result = await response.json();

          if (result.success) {
            const tbody = document.getElementById("partiesBody");
            tbody.innerHTML = result.data
              .map(
                (item, index) => `
              <tr>
                <td><span class="rank-badge">${index + 1}</span></td>
                <td><strong>${item.party_name}</strong></td>
                <td><strong>${item.vote_count || 0}</strong></td>
                <td>
                  <div>${item.vote_percentage || 0}%</div>
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: ${item.vote_percentage || 0}%"></div>
                  </div>
                </td>
              </tr>
            `
              )
              .join("");
          } else {
            document.getElementById("partiesBody").innerHTML =
              '<tr><td colspan="4">No party data available</td></tr>';
          }
        } catch (error) {
          console.error("Party results error:", error);
        }
      }

      function switchTab(tabName) {
        // Hide all tabs
        document
          .querySelectorAll(".tab-content")
          .forEach((tab) => tab.classList.remove("active"));
        document
          .querySelectorAll(".tab-btn")
          .forEach((btn) => btn.classList.remove("active"));

        // Show selected tab
        document.getElementById(tabName).classList.add("active");
        event.target.classList.add("active");
      }

      function showAlert(message, type) {
        const alert = document.getElementById("alert");
        alert.textContent = message;
        alert.className = `alert show alert-${type}`;
      }

      function logout() {
        if (confirm("Are you sure you want to logout?")) {
          localStorage.removeItem("adminToken");
          localStorage.removeItem("adminInfo");
          window.location.href = "admin-login.html";
        }
      }
    </script>
  </body>
</html>
