<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vote for Party</title>
    <link rel="stylesheet" href="../css/style.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üéØ Vote for Party</h1>
        <p>Indirect Voting</p>
      </header>

      <nav>
        <a href="../index.html">Home</a>
        <a href="vote-candidate.html">Vote for Candidate</a>
        <a href="results.html">Results</a>
      </nav>

      <main>
        <div id="alert" class="alert"></div>
        <div id="loading" class="loading" style="display: none"></div>

        <div class="form-container">
          <div class="card">
            <h2>Cast Your Party Vote</h2>
            <form id="partyVoteForm">
              <div class="form-group">
                <label for="voterId">Your Voter ID *</label>
                <input
                  type="number"
                  id="voterId"
                  required
                  placeholder="Enter your voter ID"
                />
              </div>

              <div id="partiesList" class="form-group">
                <label>Select Political Party *</label>
                <div id="partiesContainer"></div>
              </div>

              <div class="form-group">
                <label for="electionAreaId">Election Area ID *</label>
                <input
                  type="number"
                  id="electionAreaId"
                  required
                  placeholder="Enter election area ID"
                  value="1"
                />
              </div>

              <button type="submit" class="btn btn-success" style="width: 100%">
                Cast Party Vote
              </button>
            </form>
          </div>
        </div>

        <div class="info-section">
          <h3>Party Voting Instructions</h3>
          <div class="steps">
            <div class="step">
              <span class="step-number">1</span>
              <p>Enter your Voter ID</p>
            </div>
            <div class="step">
              <span class="step-number">2</span>
              <p>Choose your preferred party</p>
            </div>
            <div class="step">
              <span class="step-number">3</span>
              <p>Submit your party vote</p>
            </div>
          </div>
          <p style="text-align: center; margin-top: 20px; color: #666">
            ‚ö†Ô∏è You can only vote for ONE party. Choose wisely!
          </p>
        </div>
      </main>
    </div>

    <script src="../js/api.js"></script>
    <script>
      // Load parties on page load
      async function loadParties() {
        try {
          showLoading(true);
          const result = await getAllParties();
          const parties = result.data;

          const container = document.getElementById("partiesContainer");
          container.innerHTML = "";

          if (parties.length === 0) {
            container.innerHTML =
              '<p style="color: #dc3545;">No parties available</p>';
          } else {
            parties.forEach((party) => {
              const div = document.createElement("div");
              div.className = "party-item";
              div.innerHTML = `
                            <label style="display: flex; align-items: center; cursor: pointer; width: 100%;">
                                <input type="radio" name="party" value="${party.id}" style="margin-right: 10px;">
                                <div>
                                    <strong style="font-size: 1.2em;">${party.PartyName}</strong>
                                </div>
                            </label>
                        `;
              container.appendChild(div);
            });
          }
        } catch (error) {
          showAlert("Error loading parties: " + error.message, "error");
        } finally {
          showLoading(false);
        }
      }

      // Handle form submission
      document
        .getElementById("partyVoteForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const voterId = parseInt(document.getElementById("voterId").value);
          const partyRadio = document.querySelector(
            'input[name="party"]:checked'
          );
          const electionAreaId = parseInt(
            document.getElementById("electionAreaId").value
          );

          if (!partyRadio) {
            showAlert("Please select a party", "error");
            return;
          }

          const partyId = parseInt(partyRadio.value);

          try {
            showLoading(true);

            const voteData = {
              voter_id: voterId,
              party_id: partyId,
              election_area_id: electionAreaId,
            };

            const result = await castPartyVote(voteData);

            showAlert(
              "Party vote cast successfully! Transaction Hash: " +
                result.data.blockchain.transactionHash,
              "success"
            );

            // Reset form
            document.getElementById("partyVoteForm").reset();

            // Redirect to results after 3 seconds
            setTimeout(() => {
              window.location.href = "results.html";
            }, 3000);
          } catch (error) {
            showAlert("Error casting party vote: " + error.message, "error");
          } finally {
            showLoading(false);
          }
        });

      // Load parties on page load
      loadParties();
    </script>
  </body>
</html>
